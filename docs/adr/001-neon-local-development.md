# ADR-001: ローカル開発環境のデータベース接続方式

## ステータス

**承認** (2026-02)

## コンテキスト

チーム開発において、各開発者がローカル環境でNeonデータベースに接続する方式を決定する必要がある。

### 要件

1. **初回セットアップの自動化**: 開発者が「何も考えずに」設定できる
2. **最新データからの開始**: 開発開始時にdevelopmentブランチの最新データを使用
3. **Mac対応**: 追加の設定変更を強制しない

### 制約

- **gRPC FUSE設定を強制できない**: チームメンバーにDocker Desktopの設定変更を強制したくない

## 検討した選択肢

### 選択肢1: Neon Local（エフェメラルブランチ）

Docker Composeで`neon_local`コンテナを起動し、自動的にエフェメラルブランチを管理。

**利点**:
- 完全自動（ブランチ作成・削除）
- Gitブランチ連携が可能
- NEON_API_KEY設定のみで動作

**欠点**:
- **MacでgRPC FUSE設定が必須**（VirtioFSにバグあり）
- HTTP接続を強制される（WebSocket不可）
- 本番環境（WebSocket）との差異
- 追加のDockerコンテナが必要
- **dotenvx管理との相性が悪い**: `dotenvx run -- docker compose up` のような起動フローが必要

**評価**: 制約により**採用不可**

### 選択肢2: 手動ブランチ + 自動化スクリプト

各開発者に永続的な個人ブランチを作成し、スクリプトでセットアップとデータ同期を自動化。

**利点**:
- gRPC FUSE設定不要
- WebSocket接続を維持（本番と同じ）
- コード変更なし

**欠点**:
- Neon CLIのインストール・認証が必要
- ブランチが永続的（削除は手動）
- 「完全自動」ではない

**評価**: 制約を満たす**採用可能**

### 選択肢3: 両方式のハイブリッド対応

環境変数で切り替え可能にし、開発者が選択。

**利点**:
- 柔軟性が高い

**欠点**:
- 実装が複雑
- ドキュメント・サポートが二重に必要
- チーム内で環境差異が生じる

**評価**: 複雑性により**非推奨**

## 決定

**選択肢2: 手動ブランチ + 自動化スクリプト** を採用する。

### 決定理由

| 要因 | 評価 |
|------|------|
| gRPC FUSE設定 | 強制したくない → 方式1は不可 |
| HTTP通信の強制 | 方式1はHTTP強制、本番はWebSocket → 差異を避けたい |
| 追加コンテナ | 方式1は`neon_local`コンテナ追加 → シンプルに保ちたい |
| dotenvx管理 | 方式1は`dotenvx run -- docker compose up`が必要 → 避けたい |
| Neon CLI依存 | 許容できる → 方式2は可 |
| コード変更 | なし（本番と同じWebSocket接続） |
| 自動化レベル | `./bin/setup` + `./bin/dev` で十分 |

### 受け入れるトレードオフ

1. **Neon CLIのインストール・認証が必要**
   - `brew install neonctl` が必要
   - 初回に `neon auth` でブラウザ認証
   - → スクリプトがガイドするので問題なし

2. **ブランチが永続的**
   - 開発者ごとに1つのブランチが残り続ける
   - → `./bin/cleanup` で削除可能

3. **同期の信頼性**
   - `neon branches reset` が失敗する可能性
   - → エラーハンドリングとリトライで対応

## 影響

### 作成したファイル

- `bin/setup` - 初回セットアップスクリプト
- `bin/cleanup` - ブランチ削除スクリプト
- `bin/dev` - 開発サーバー起動（同期機能付き）
- `bin/runenv` - 環境変数読み込みラッパー
- `docs/neon-branch-operations.md` - 操作ガイド

### 開発者への影響

- 初回: `./bin/setup` を実行（Neon認証が必要）
- 日常: `./bin/dev` のみで開発開始
- 終了: `./bin/cleanup` でクリーンアップ（任意）

## 参考

- [Neon Local GitHub](https://github.com/neondatabase/neon-local)
- [Neon CLI Quickstart](https://neon.com/docs/reference/cli-quickstart)
- [dotenvx](https://dotenvx.com/)
