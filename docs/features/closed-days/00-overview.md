# 休業日管理機能 設計ドキュメント

## 概要

週末（金/土/日）に営業するバーにおいて、営業しない日（休業日）を管理画面から設定できるようにする機能。

## ビジネスコンテキスト

SOY-POYは金・土・日に営業するコミュニティバー。各営業候補日の状態は以下の3つに分類される:

| 状態 | 条件 | 説明 |
| ------ | ------ | ------ |
| イベント営業 | `events` テーブルに該当日あり | イベントが入っている日。自動的に営業 |
| 通常営業（バー営業） | イベントなし、休業日でもない | デフォルトの営業状態 |
| 休業 | `closed_days` テーブルに登録済み | 明示的に営業を取り消した日 |

### 営業判定フロー

```text
ある日が営業日か？

  金/土/日である？
    ├─ No → 営業なし（平日）
    └─ Yes → イベントがある？
                ├─ Yes → イベント営業
                └─ No → closed_daysに登録済み？
                          ├─ Yes → 休業
                          └─ No → 通常営業（バー営業）
```

## データモデリング

### ClosedDay の位置づけ

#### 分類: 例外リスト型リソース（通常営業の取り消し）

- デフォルトで営業する日（金/土/日）に対して「この日は休み」と宣言する例外リスト
- イベントのような「出来事の記録」ではなく、デフォルト状態に対する「上書き」
- ライフサイクルは月単位。月ごとにまとめて設定・更新する運用を想定

### Event との関係

- **DB上の参照関係: なし**（独立したテーブル）
- **ビジネスルール上の関係: 排他**（同一日付にイベントと休業日は共存不可）
- フロントエンドでの突合は日付文字列（`YYYY-MM-DD`）ベースで行う

## バリデーションルール

| ルール | レイヤー | 詳細 |
| --- | --- | --- |
| イベント日との重複禁止 | Service | `syncMonth` 時に `eventService` 経由でイベント一覧を取得し、日付の重複をチェック。重複があればエラー |
| 日付の一意性 | DB | 同一日付の重複登録を防止（date カラムに UNIQUE 制約を追加） |
| 曜日制限 | なし | APIレベルでは曜日を制限しない（将来の営業日変更に対応可能にするため） |

## 実装フェーズ

| Phase | ドキュメント | 内容 |
| ------- | ------------- | ------ |
| 1 | [01-db-repository.md](./01-db-repository.md) | DB スキーマ変更 + Repository 層 |
| 2 | [02-service.md](./02-service.md) | Service 層（syncMonth ロジック） |
| 3 | [03-trpc-api.md](./03-trpc-api.md) | tRPC API エンドポイント |
| 4 | [04-admin-ui.md](./04-admin-ui.md) | Admin UI（カレンダートグル画面） |
