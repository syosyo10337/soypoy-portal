#!/bin/bash
# åˆå›žã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—: Neonèªè¨¼ + å€‹äººãƒ–ãƒ©ãƒ³ãƒä½œæˆ + .env.local.devç”Ÿæˆ
#
# ä½¿ç”¨æ–¹æ³•:
#   ./bin/setup          # é€šå¸¸ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆæ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã¯å†åˆ©ç”¨ï¼‰
#   ./bin/setup --reset  # ãƒªã‚»ãƒƒãƒˆï¼ˆæ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤ã—ã¦å†ä½œæˆï¼‰
#
# ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¾ã™:
# 1. .env.keysã®å­˜åœ¨ç¢ºèª
# 2. Neon CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèªï¼ˆãªã‘ã‚Œã°ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¡ˆå†…ï¼‰
# 3. Neonèªè¨¼ï¼ˆæœªèªè¨¼ã®å ´åˆï¼‰
# 4. å€‹äººç”¨ãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆï¼ˆæ—¢å­˜ãªã‚‰å†åˆ©ç”¨ã€--resetãªã‚‰å‰Šé™¤â†’å†ä½œæˆï¼‰
# 5. .env.local.devã®ç”Ÿæˆ

set -euo pipefail

# å¼•æ•°è§£æž
RESET_MODE=false
while [[ $# -gt 0 ]]; do
  case $1 in
    --reset)
      RESET_MODE=true
      shift
      ;;
    -h|--help)
      echo "ä½¿ç”¨æ–¹æ³•: ./bin/setup [--reset]"
      echo ""
      echo "ã‚ªãƒ—ã‚·ãƒ§ãƒ³:"
      echo "  --reset  æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤ã—ã¦å†ä½œæˆ"
      exit 0
      ;;
    *)
      echo "ä¸æ˜Žãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
      echo "ä½¿ç”¨æ–¹æ³•: ./bin/setup [--reset]"
      exit 1
      ;;
  esac
done

echo "ðŸ”§ é–‹ç™ºç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ã¾ã™..."
if [ "$RESET_MODE" = true ]; then
  echo "   (ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰: æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤ã—ã¦å†ä½œæˆ)"
fi
echo ""

# 1. .env.keysã®å­˜åœ¨ç¢ºèª
if [ ! -f .env.keys ]; then
  echo "âŒ .env.keys ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
  echo "   ãƒãƒ¼ãƒ ãƒªãƒ¼ãƒ‰ã‹ã‚‰å–å¾—ã—ã¦ãã ã•ã„"
  exit 1
fi

# 2. Neon CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
if ! command -v neon &> /dev/null; then
  echo "âŒ Neon CLIãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“"
  echo ""
  echo "ä»¥ä¸‹ã®ã‚³ãƒžãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„:"
  echo "  brew install neonctl"
  echo ""
  echo "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã€å†åº¦ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„"
  exit 1
fi

# 3. Neonèªè¨¼ï¼ˆæœªèªè¨¼ã®å ´åˆï¼‰
if ! neon me &> /dev/null 2>&1; then
  echo "ðŸ” Neonã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„..."
  neon auth
fi

# 4. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDå–å¾—
PROJECT_ID=$(npx @dotenvx/dotenvx get NEON_PROJECT_ID -f .env.local 2>/dev/null || echo "")
if [ -z "$PROJECT_ID" ]; then
  echo "âŒ NEON_PROJECT_ID ãŒ .env.local ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“"
  exit 1
fi

# 5. ãƒ¦ãƒ¼ã‚¶ãƒ¼åå–å¾—ï¼ˆGitã¾ãŸã¯ã‚·ã‚¹ãƒ†ãƒ ï¼‰
if git config user.name &> /dev/null; then
  USERNAME=$(git config user.name | tr ' ' '-' | tr '[:upper:]' '[:lower:]')
else
  USERNAME=$(whoami)
fi
BRANCH_NAME="dev-${USERNAME}"

# 6. å€‹äººãƒ–ãƒ©ãƒ³ãƒã®ä½œæˆ
BRANCH_EXISTS=$(neon branches get "$BRANCH_NAME" --project-id "$PROJECT_ID" &> /dev/null && echo "true" || echo "false")

# ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ‰ã§æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒãŒã‚ã‚Œã°å‰Šé™¤
if [ "$RESET_MODE" = true ] && [ "$BRANCH_EXISTS" = true ]; then
  echo "ðŸ—‘ï¸  æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã‚’å‰Šé™¤: $BRANCH_NAME"
  neon branches delete "$BRANCH_NAME" --project-id "$PROJECT_ID"
  BRANCH_EXISTS=false
fi

# ãƒ–ãƒ©ãƒ³ãƒãŒãªã‘ã‚Œã°ä½œæˆã€ã‚ã‚Œã°å†åˆ©ç”¨
if [ "$BRANCH_EXISTS" = true ]; then
  echo "âœ… æ—¢å­˜ãƒ–ãƒ©ãƒ³ãƒã‚’ä½¿ç”¨: $BRANCH_NAME"
else
  echo "ðŸŒ¿ å€‹äººãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ: $BRANCH_NAME"
  neon branches create \
    --project-id "$PROJECT_ID" \
    --name "$BRANCH_NAME" \
    --parent development
fi

# 7. æŽ¥ç¶šæ–‡å­—åˆ—ã‚’å–å¾—ã—ã¦.env.local.devã«ä¿å­˜
CONNECTION_STRING=$(neon connection-string "$BRANCH_NAME" --project-id "$PROJECT_ID")

cat > .env.local.dev << EOF
# å€‹äººç”¨é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒã®æŽ¥ç¶šè¨­å®š
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯.gitignoreã«å«ã¾ã‚Œã¦ãŠã‚Šã€ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¾ã›ã‚“

NETLIFY_DATABASE_URL="${CONNECTION_STRING}"
NEON_BRANCH_NAME="${BRANCH_NAME}"
EOF

echo ""
echo "ðŸŽ‰ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ï¼"
echo ""
echo "ðŸ“ ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
echo "   .env.local.dev (å€‹äººç”¨ãƒ–ãƒ©ãƒ³ãƒæŽ¥ç¶šè¨­å®š)"
echo ""
echo "ðŸš€ é–‹ç™ºã‚’é–‹å§‹ã™ã‚‹ã«ã¯:"
echo "   ./bin/dev"
echo ""
